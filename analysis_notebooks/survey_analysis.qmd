---
title: "Survey Analysis"
author:
  - "Eva Kormann"
  - "Thomas Klebel"
format: html
editor: visual
execute: 
  echo: true
  warning: false
---

```{r}
#| output: false
#| echo: false

library(tidyverse)
library(psych)
library(ggchicklet)
library(patchwork)
library(janitor)
library(hrbrthemes)

knitr::opts_chunk$set(dpi = 400)

# Get data
use_targets <- TRUE # Set to false if data is not received by targets pipeline

if (use_targets) {
  
  source("R/analysis.R")
  df <- targets::tar_read(recoded_data)
  var_overview <- targets::tar_read(var_overview)

} else {
  
  library(here)
  functions <- here("R", "analysis.R")
  source(functions)
  data <- here("data", "processed", "preprocessed_data.csv")
  vars <- here("data", "processed", "var_overview.csv")
  df <- read_csv(data)
  var_overview <- read_csv(vars)
}
```

# Overview

## Research

### Open Science

Multiple questions within the survey inquired about how much participants agreed with certain statements related to different Open Science practices. The full statements in this group and their respective variable ids are presented in the table below.

```{r}
os <- c("X38", "X39", "X42", "X43", "X45",
        "X46", "X48", "X49", "X50", "X52")

knitr::kable(var_overview[var_overview$var_id %in% os, 1:2])
```

In the following figure, responses are visualized to the Open Science questions. They are sorted by the amount of agreement with these statements. Proportions of the different answer categories were calculated after removing missing and "don't know" responses. These responses are plotted separately on the right hand side, indicating their percentage of the total responses.

```{r os_overview, fig.height = 7.5, fig.width = 8}
plot_agreement_overview(df, var_overview, os)
```

### Reporting and Academic Integrity

Nine items inquire about the agreement with statements related to reporting and academic integrity. The full items are presented in the table below.

```{r}
raia <- c("X19", "X17", "X18", "X20", "X21",
          "X40", "X44", "X41", "X47")
knitr::kable(var_overview[var_overview$var_id %in% raia, 1:2])
```

Caution: Question X19 ("Changes to the experimental data \[...\] are acceptable") is the only statement phrased in the opposite direction. This needs to be considered when interpreting the responses.

```{r raia_overview, fig.height = 7, fig.width = 8}
plot_agreement_overview(df, var_overview, raia)
```

Six questions were about the frequency with which certain questionable research practices around reporting occur at the respondent's institution (see table below).

```{r}
raif <- c("X24", "X25", "X26", "X27", "X28", "X29")
knitr::kable(var_overview[var_overview$var_id %in% raif, 1:2])
```

The following overview plot is sorted by the proportion of "never" and "rarely" responses. These questions could not be skipped, therefore there are no missing answers.

```{r raif_overview, fig.height = 5, fig.width = 8}
plot_frequency_overview(df, var_overview, raif)
```

## Education

While most questions referred to research, others focused more on education at the respective HEI. Respondents were inquired about their agreement with certain education-related statements (see table below), most of them also related to Open Science, but in an educational context.

```{r}
edua <- c("X16", "X22", "X23", "X51")
knitr::kable(var_overview[var_overview$var_id %in% edua, 1:2])
```

```{r edua_overview, fig.height = 4, fig.width = 8}
plot_agreement_overview(df, var_overview, edua, sort = FALSE)
```

The occurrence of three different types of student misconduct were also investigated within the survey (see table and figure below).

```{r}
eduf <- c("X30", "X31", "X32")
knitr::kable(var_overview[var_overview$var_id %in% eduf, 1:2])
```

```{r eduf_overview, fig.height = 3.5, fig.width = 8}
plot_frequency_overview(df, var_overview, eduf)
```

## Institution/Administration

The survey contained five questions on how misconduct is handled at the respondent's respective institution. Respondents indicated the frequency with which certain practices occurred at their institution.

```{r}
adm <- c("X33", "X34", "X35", "X36", "X37")
knitr::kable(var_overview[var_overview$var_id %in% adm, 1:2])
```

```{r adm_overview, fig.height = 4.5, fig.width = 8}
plot_frequency_overview(df, var_overview, adm)
```

One general item also inquired about the following statement: "Overall, the processes at my higher education institution are organised in a clear and transparent manner". The agreement is visualized by the different institutional vs. the national survey.

```{r hei_processes, fig.height = 4.5, fig.width = 8}
df$X63 <- factor(df$X63,
                 levels = c("National", "LPU", "SumDU", "DonNU", "LutskNTU"))
plot_agreement(df, var_overview, "X15", group = "X63")
```

# Development over Time

## Research

### Open Science

```{r}
knitr::kable(var_overview[var_overview$var_id %in% os, 1:2])
```

```{r os_development, fig.height = 9, fig.width = 8}

plots <- list()

for (q in os) {
  if (q %in% paste0("X", 38:53)) {
    legend <- TRUE
  } else {legend <- FALSE}
  plot <- plot_agreement_line(df, question = q, legend)
  plots[[q]] <- plot
}

wrap_plots(plots, ncol = 3) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10))
```

### Reporting and Academic Integrity

```{r}
knitr::kable(var_overview[var_overview$var_id %in% raia, 1:2])
```

```{r raia_development, fig.height = 7, fig.width = 8}
 
plots <- list()

for (q in raia) {
  if (q %in% paste0("X", 38:53)) {
    legend <- TRUE
  } else {legend <- FALSE}
  plot <- plot_agreement_line(df, question = q, legend)
  plots[[q]] <- plot
}

wrap_plots(plots, ncol = 3) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10))
```

```{r}
knitr::kable(var_overview[var_overview$var_id %in% raif, 1:2])
```

```{r raif_development, fig.height = 5, fig.width = 8}

plots <- list()

for (q in raif) {
  plot <- plot_frequency_line(df, question = q, legend = TRUE, ylim = 50)
  plots[[q]] <- plot
}

wrap_plots(plots, ncol = 3) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10))
```

### Education

```{r}
knitr::kable(var_overview[var_overview$var_id %in% edua, 1:2])
```

```{r edua_development, fig.height = 5.5, fig.width = 8}
 
plots <- list()

for (q in edua) {
  if (q %in% paste0("X", 38:53)) {
    legend <- TRUE
  } else {legend <- FALSE}
  plot <- plot_agreement_line(df, question = q, legend)
  plots[[q]] <- plot
}

wrap_plots(plots, ncol = 2) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10))
```

```{r}
knitr::kable(var_overview[var_overview$var_id %in% eduf, 1:2])
```

```{r eduf_development, fig.height = 2.5, fig.width = 8}

plots <- list()

for (q in eduf) {
  plot <- plot_frequency_line(df, question = q, legend = TRUE, ylim = 40)
  plots[[q]] <- plot
}

wrap_plots(plots, ncol = 3) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10))
```

### Institution/Administration

```{r}
knitr::kable(var_overview[var_overview$var_id %in% adm, 1:2])
```

```{r adm_development, fig.height = 5, fig.width = 8}

plots <- list()

for (q in adm) {
  plot <- plot_frequency_line(df, question = q, legend = TRUE)
  plots[[q]] <- plot
}

wrap_plots(plots, ncol = 3) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10))
```

An alternative plot type to the line plot is the area plot. For the following exemplary item ("Overall, the processes at my higher education institution are organised in a clear and transparent manner") both plots are shown for comparison.

```{r hei_processes_comparison, fig.height = 3.2, fig.width = 8}

line <- plot_agreement_line(df, "X15", FALSE)
area <- plot_agreement_area(df, "X15", TRUE)

line + area
```
