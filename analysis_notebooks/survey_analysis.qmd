---
title: "Survey Analysis"
author:
  - "Eva Kormann"
  - "Thomas Klebel"
format: pdf
editor: visual
execute: 
  echo: true
  warning: false
---

```{r}
#| output: false
#| echo: false

library(tidyverse)
library(psych)
library(ggchicklet)
library(patchwork)
library(janitor)
library(hrbrthemes)

source("R/analysis.R")

# Get data
use_targets <- TRUE # Set to false if data is not received by targets pipeline

if (use_targets) {
  
  df <- targets::tar_read(recoded_data)
  var_overview <- targets::tar_read(var_overview)

} else {
  
  library(here)
  data <- here("data", "processed", "preprocessed_data.csv")
  vars <- here("data", "processed", "var_overview.csv")
  df <- read_csv(data)
  var_overview <- read_csv(vars)
}
```

# Comparison between items

## Agreement X38-X52 (open science focus)

The overviews are so far produced by the order of items in the survey. However, we plan to rearrange the items more by related topics and create overviews that way.

### Comparison Plot

This plot compares the selected answer categories across different agreement items and sorts them based on how many people agree. For better visualization, the labels are (for now) replaced by the short variable id. It might make sense to include only response from one year in one such plot (because otherwise some respondents would appear multiple times, while others won't). The option to filter for a specific year is already implemented.

```{r}
columns <- paste0("X", 38:52)
plot_agreement_overview(df, var_overview, columns, sort = TRUE)
```

### Full Statements

To look up the full statements that are referred to by the variable ids, we derive them here from our variable overview.

```{r}
knitr::kable(var_overview[var_overview$var_id %in% columns, 1:2])
```

## Agreement X15-X23 (research integrity focus)

### Comparison Plot

Caution: X19 is phrased as an inverted item, while all others are not. This needs to be considered for interpretation

```{r}

columns <- paste0("X", 15:23)
plot_agreement_overview(df, var_overview, columns)
```

### Full Statements

```{r}
knitr::kable(var_overview[var_overview$var_id %in% columns, 1:2])
```

## Frequency of certain practices at own institution (X24-X37)

### Comparison Plot

```{r}
columns <- paste0("X", 24:37)
plot_frequency_overview(df, var_overview, columns)
```

### Full Statements

```{r}
knitr::kable(var_overview[var_overview$var_id %in% columns, 1:2])
```

# Comparison within one item

## Agreement

### Open data

"Experimental data should be published as openly as possible." (X45)

Data here is grouped by the survey year, therefore allowing quick visual comparisons. There is a plan to have more specific visualizations for developments over time.

```{r}
plot_agreement(df, var_overview, "X45", group = "X64")
```

## Frequency of certain practices at own institution

### Fabrications

"Making up data or facts about a scientific activity, for example, a research experiment." (X26)

Data here is filtered for the year 2023 and grouped by academic role (which is a variable that could benefit from merging some categories). The groups are sorted by the frequency they estimate. However, we could sort the groups also in some other way as desired.

```{r}
plot_frequency(df, var_overview, "X26", group = "X8", filter = "X64", filter_val = "2023", sort = TRUE)
```

## 

Additionally to these plots, we can also produce large overview tables that would allow to investigate certain items, groups or categories more closely. However, these were left out for now due to their size.
